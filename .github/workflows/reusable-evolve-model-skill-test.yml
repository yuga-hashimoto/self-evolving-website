name: Reusable AI Evolution (Skill-Based)

on:
  workflow_call:
    inputs:
      model_id:
        required: true
        type: string
      model_display_name:
        required: true
        type: string
      anthropic_model:
        required: true
        type: string
      commit_prefix:
        required: true
        type: string
    secrets:
      model_api_key:
        required: true
      ga4_property_id:
        required: true
      google_application_credentials_json:
        required: true
      serper_api_key:
        required: true

jobs:
  evolve:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # We need a token that can push code. 
          # In the original workflow, it used secrets.GITHUB_TOKEN to push.
          # Here we'll use the automatically provided GITHUB_TOKEN from the caller context unless passed explicitly,
          # but usually secrets are passed. However, `secrets.GITHUB_TOKEN` is available in reusable workflows automatically if permissions are set correctly.
          # We will stick to the default token permission inheritance or explicit use.
          # But wait, looking at the original files: `git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git`
          # This confirms we need access to GITHUB_TOKEN. It is context available.
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Node.js Setup
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Cache Next.js Build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules/.cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: Initialize Metrics
        run: |
          echo "workflow_start=$(date +%s)" >> $GITHUB_ENV
          echo "build_failures=0" >> $GITHUB_ENV
          echo "retry_count=0" >> $GITHUB_ENV

      - name: Create Evolution Branch
        id: create-branch
        run: |
          TIMESTAMP=$(TZ=Asia/Tokyo date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="ai-evolution/${{ inputs.model_id }}-${TIMESTAMP}"

          # Git configuration
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Create branch
          git checkout -b "$BRANCH_NAME"

          # Create empty commit (to enable PR creation)
          git commit --allow-empty -m "üöÄ AI Evolution Started - ${{ inputs.model_display_name }}" \
            -m "Timestamp: $(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M JST')" \
            -m "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "‚úÖ Created branch: $BRANCH_NAME"
        env:
          TZ: Asia/Tokyo

      - name: Create Draft PR
        id: create-pr
        run: |
          # Create PR body (placeholder)
          cat > /tmp/pr-body.md <<'EOF'
          ## AI Evolution - ${{ inputs.model_display_name }}

          **Status:** üîÑ Implementation in Progress

          ### Context
          Current analytics data shows opportunities for improvement.

          ### Implementation
          Claude Code is analyzing metrics and implementing changes...

          ### Screenshots
          Will be added after implementation completes.

          ---
          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

          # Push branch to remote
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin "${{ steps.create-branch.outputs.branch_name }}"

          # Create Draft PR
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ steps.create-branch.outputs.branch_name }}" \
            --title "ü§ñ AI Evolution (${{ inputs.model_display_name }}) - $(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M JST')" \
            --body-file /tmp/pr-body.md \
            --draft)

          PR_NUMBER=$(gh pr view "$PR_URL" --json number -q '.number')

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ Created PR #$PR_NUMBER: $PR_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Tokyo

      - name: Fetch Analytics
        run: node scripts/fetch-analytics.js
        env:
          MODEL_ID: ${{ inputs.model_id }}
          GA4_PROPERTY_ID: ${{ secrets.ga4_property_id }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.google_application_credentials_json }}

      - name: Prepare Skill Context
        id: prepare-skill
        run: |
          # Read skill file content (excluding YAML frontmatter)
          SKILL_CONTENT=$(awk '/^---$/{count++; next} count>=2' .claude/skills/evolve-game/SKILL.md)

          # Read analytics data
          ANALYTICS_DATA=$(cat public/models/${{ inputs.model_id }}/analytics.json 2>/dev/null || echo '{}')

          # Read changelog data (latest 3 entries only)
          CHANGELOG_DATA=$(cat public/models/${{ inputs.model_id }}/changelog-jp.json 2>/dev/null | jq '.[0:3]' || echo '[]')

          # Compose prompt with skill content and context data
          SKILL_PROMPT="$SKILL_CONTENT

          ---

          # Current Context for Model: ${{ inputs.model_id }}

          Working directory: src/app/models/${{ inputs.model_id }}/playground
          You may also edit:
          - src/app/api/${{ inputs.model_id }}/ - Your dedicated API Routes namespace
          - src/components/icons/Icons.tsx - Icon definitions
          - public/models/${{ inputs.model_id }}/changelog-jp.json - Change history (Japanese)
          - public/models/${{ inputs.model_id }}/changelog-en.json - Change history (English)

          ## Current Analytics Data:
          $ANALYTICS_DATA

          ## Recent Change History (last 3 entries):
          $CHANGELOG_DATA

          ---

          # üö® IMPORTANT: Mobile Compatibility Checklist

          **Before implementation, confirm:**

          ‚úÖ Is canvas size dynamically set according to screen size?
          ‚úÖ Are touch controls intuitive and comfortable?
          ‚úÖ Is it easy to see and operate on small screens?
          ‚úÖ Is there feedback?

          **After implementation, confirm:**

          ‚úÖ Are you getting screen size and setting size dynamically?
          ‚úÖ Are touch events processed continuously?
          ‚úÖ Is swipe detection adjusted according to screen size?
          ‚úÖ Are you not using hardcoded values?
          "


          echo "skill_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$SKILL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Start Dev Server
        id: start-dev-server
        run: |
          # Start dev server in background for search API
          npm run dev &
          DEV_PID=$!
          echo "dev_pid=$DEV_PID" >> $GITHUB_OUTPUT

          # Wait for server to start with timeout
          echo "Waiting for dev server to start..."
          TIMEOUT=20
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -s http://localhost:3131 > /dev/null 2>&1; then
              echo "‚úÖ Dev server is ready (PID: $DEV_PID) after ${ELAPSED}s"
              exit 0
            fi
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          echo "‚ùå Dev server failed to start within ${TIMEOUT}s"
          exit 1
        env:
          SERPER_API_KEY: ${{ secrets.serper_api_key }}

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright for Screenshots
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          npx playwright install chromium --with-deps

      - name: Install Playwright Dependencies Only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          npx playwright install-deps chromium

      - name: Take Before Screenshot
        run: |
          node scripts/take-screenshot.js
        env:
          MODEL_ID: ${{ inputs.model_id }}
          SCREENSHOT_SUFFIX: before
          TZ: Asia/Tokyo

      - name: Record Claude Code Start Time
        run: echo "claude_code_start=$(date +%s)" >> $GITHUB_ENV

      - name: Claude Code Execution (Skill-Based)
        uses: anthropics/claude-code-action@v1.0.29
        with:
          anthropic_api_key: ${{ secrets.model_api_key }}
          prompt: ${{ steps.prepare-skill.outputs.skill_prompt }}
          claude_args: |
            --allowedTools "Edit(src/app/models/${{ inputs.model_id }}/**),Edit(src/app/api/${{ inputs.model_id }}/**),Edit(src/components/icons/Icons.tsx),Edit(public/models/${{ inputs.model_id }}/changelog-jp.json),Edit(public/models/${{ inputs.model_id }}/changelog-en.json),Write(src/app/models/${{ inputs.model_id }}/**),Write(src/app/api/${{ inputs.model_id }}/**),Write(src/components/icons/Icons.tsx),Read,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(gh:*),Bash(bash scripts/web-search.sh*),Bash(jq:*),Glob,Grep,TodoWrite"
          show_full_output: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ inputs.anthropic_model }}
          SERPER_API_KEY: ${{ secrets.serper_api_key }}
          MODEL_ID: ${{ inputs.model_id }}

      - name: Record Claude Code Duration
        run: |
          CLAUDE_CODE_END=$(date +%s)
          CLAUDE_CODE_DURATION=$((CLAUDE_CODE_END - ${{ env.claude_code_start }}))
          echo "claude_code_duration=$CLAUDE_CODE_DURATION" >> $GITHUB_ENV
          echo "‚úÖ Claude Code execution took ${CLAUDE_CODE_DURATION}s"

      - name: Check for Changes
        id: changes
        run: |
          # Check for changes in allowed directories
          PLAYGROUND_CHANGES=$(git status --porcelain src/app/models/${{ inputs.model_id }}/playground)
          API_CHANGES=$(git status --porcelain src/app/api/${{ inputs.model_id }})
          ICONS_CHANGES=$(git status --porcelain src/components/icons/Icons.tsx)

          if [[ -n "$PLAYGROUND_CHANGES" ]] || [[ -n "$API_CHANGES" ]] || [[ -n "$ICONS_CHANGES" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
            echo "Playground: $PLAYGROUND_CHANGES"
            echo "API: $API_CHANGES"
            echo "Icons: $ICONS_CHANGES"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes"
          fi

      # === Safety Check & Auto-Fix Loop (Attempt 1) ===
      - name: Safety Check (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true'
        id: check_1
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(npm run build && npx tsc --noEmit 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "NEEDS_FIX=true" >> $GITHUB_ENV
            echo "$OUTPUT" > error_log.txt

            # Error analysis
            TYPESCRIPT_ERRORS=$(grep -c "TS[0-9]\+:" error_log.txt || echo 0)
            BUILD_ERRORS=$(grep -c "error:" error_log.txt || echo 0)

            echo "typescript_errors=$TYPESCRIPT_ERRORS" >> $GITHUB_ENV
            echo "build_errors=$BUILD_ERRORS" >> $GITHUB_ENV
            echo "build_failures=$((${build_failures:-0} + 1))" >> $GITHUB_ENV

            echo "‚ùå Attempt 1 failed (TS: $TYPESCRIPT_ERRORS, Build: $BUILD_ERRORS)"
          else
            echo "NEEDS_FIX=false" >> $GITHUB_ENV
            echo "‚úÖ Attempt 1 passed"
          fi

      - name: Prepare Fix Prompt (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        id: prepare_fix_1
        run: |
          echo "fix_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "The build failed with the following errors. Please fix the code to resolve these issues. Do NOT change the functionality, just fix the syntax or type errors." >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  IMPORTANT: Ensure mobile compatibility while fixing errors:" >> $GITHUB_OUTPUT
          echo "- Canvas must be responsive (dynamic sizing, not hardcoded values)" >> $GITHUB_OUTPUT
          echo "- Touch controls must be intuitive and work continuously" >> $GITHUB_OUTPUT
          echo "- Swipe distance should adapt to screen size" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          tail -n 50 error_log.txt >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Record Auto-Fix Start (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        run: |
          echo "autofix_1_start=$(date +%s)" >> $GITHUB_ENV
          echo "retry_count=$((${retry_count:-0} + 1))" >> $GITHUB_ENV

      - name: Auto-Fix (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1.0.29
        with:
          anthropic_api_key: ${{ secrets.model_api_key }}
          prompt: ${{ steps.prepare_fix_1.outputs.fix_prompt }}
          claude_args: |
            --allowedTools "Edit(src/app/models/${{ inputs.model_id }}/**),Edit(src/app/api/${{ inputs.model_id }}/**),Edit(src/components/icons/Icons.tsx),Edit(public/models/${{ inputs.model_id }}/changelog-jp.json),Edit(public/models/${{ inputs.model_id }}/changelog-en.json),Write(src/app/models/${{ inputs.model_id }}/**),Write(src/app/api/${{ inputs.model_id }}/**),Write(src/components/icons/Icons.tsx),Read,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(gh:*),Glob,Grep,TodoWrite"
          show_full_output: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ inputs.anthropic_model }}
          MODEL_ID: ${{ inputs.model_id }}

      - name: Record Auto-Fix Duration (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        run: |
          AUTOFIX_1_END=$(date +%s)
          AUTOFIX_1_DURATION=$((AUTOFIX_1_END - ${autofix_1_start:-0}))
          echo "autofix_1_duration=$AUTOFIX_1_DURATION" >> $GITHUB_ENV

      # === Safety Check & Auto-Fix Loop (Attempt 2) ===
      - name: Safety Check (Attempt 2)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        id: check_2
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(npm run build && npx tsc --noEmit 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "NEEDS_FIX=true" >> $GITHUB_ENV
            echo "$OUTPUT" > error_log.txt

            # Error analysis
            TYPESCRIPT_ERRORS=$(grep -c "TS[0-9]\+:" error_log.txt || echo 0)
            BUILD_ERRORS=$(grep -c "error:" error_log.txt || echo 0)

            echo "typescript_errors=$TYPESCRIPT_ERRORS" >> $GITHUB_ENV
            echo "build_errors=$BUILD_ERRORS" >> $GITHUB_ENV
            echo "build_failures=$((${build_failures:-0} + 1))" >> $GITHUB_ENV

            echo "‚ùå Attempt 2 failed (TS: $TYPESCRIPT_ERRORS, Build: $BUILD_ERRORS)"
          else
            echo "NEEDS_FIX=false" >> $GITHUB_ENV
            echo "‚úÖ Attempt 2 passed"
          fi

      - name: Prepare Fix Prompt (Attempt 2)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        id: prepare_fix_2
        run: |
          echo "fix_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "The build still failed. Please fix these errors:" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  IMPORTANT: Ensure mobile compatibility while fixing errors:" >> $GITHUB_OUTPUT
          echo "- Canvas must be responsive (dynamic sizing, not hardcoded values)" >> $GITHUB_OUTPUT
          echo "- Touch controls must be intuitive and work continuously" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          tail -n 50 error_log.txt >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Record Auto-Fix Start (Attempt 2)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        run: |
          echo "autofix_2_start=$(date +%s)" >> $GITHUB_ENV
          echo "retry_count=$((${retry_count:-0} + 1))" >> $GITHUB_ENV

      - name: Auto-Fix (Attempt 2)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1.0.29
        with:
          anthropic_api_key: ${{ secrets.model_api_key }}
          prompt: ${{ steps.prepare_fix_2.outputs.fix_prompt }}
          claude_args: |
            --allowedTools "Edit(src/app/models/${{ inputs.model_id }}/**),Edit(src/app/api/${{ inputs.model_id }}/**),Edit(src/components/icons/Icons.tsx),Edit(public/models/${{ inputs.model_id }}/changelog-jp.json),Edit(public/models/${{ inputs.model_id }}/changelog-en.json),Write(src/app/models/${{ inputs.model_id }}/**),Write(src/app/api/${{ inputs.model_id }}/**),Write(src/components/icons/Icons.tsx),Read,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(gh:*),Glob,Grep,TodoWrite"
          show_full_output: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ inputs.anthropic_model }}
          MODEL_ID: ${{ inputs.model_id }}

      - name: Record Auto-Fix Duration (Attempt 2)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        run: |
          AUTOFIX_2_END=$(date +%s)
          AUTOFIX_2_DURATION=$((AUTOFIX_2_END - ${autofix_2_start:-0}))
          echo "autofix_2_duration=$AUTOFIX_2_DURATION" >> $GITHUB_ENV

      # === Safety Check & Auto-Fix Loop (Attempt 3) ===
      - name: Safety Check (Attempt 3)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        id: check_3
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(npm run build && npx tsc --noEmit 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "NEEDS_FIX=true" >> $GITHUB_ENV
            echo "$OUTPUT" > error_log.txt

            # Error analysis
            TYPESCRIPT_ERRORS=$(grep -c "TS[0-9]\+:" error_log.txt || echo 0)
            BUILD_ERRORS=$(grep -c "error:" error_log.txt || echo 0)

            echo "typescript_errors=$TYPESCRIPT_ERRORS" >> $GITHUB_ENV
            echo "build_errors=$BUILD_ERRORS" >> $GITHUB_ENV
            echo "build_failures=$((${build_failures:-0} + 1))" >> $GITHUB_ENV

            echo "‚ùå Attempt 3 failed (TS: $TYPESCRIPT_ERRORS, Build: $BUILD_ERRORS)"
          else
            echo "NEEDS_FIX=false" >> $GITHUB_ENV
            echo "‚úÖ Attempt 3 passed"
          fi

      - name: Prepare Fix Prompt (Attempt 3)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        id: prepare_fix_3
        run: |
          echo "fix_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "Last attempt. Fix these errors:" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  CRITICAL: Ensure mobile compatibility while fixing errors:" >> $GITHUB_OUTPUT
          echo "- Canvas MUST be responsive (dynamic sizing, NOT hardcoded values)" >> $GITHUB_OUTPUT
          echo "- Touch controls MUST work continuously, not just once per tap" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          tail -n 50 error_log.txt >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Record Auto-Fix Start (Attempt 3)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        run: |
          echo "autofix_3_start=$(date +%s)" >> $GITHUB_ENV
          echo "retry_count=$((${retry_count:-0} + 1))" >> $GITHUB_ENV

      - name: Auto-Fix (Attempt 3)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1.0.29
        with:
          anthropic_api_key: ${{ secrets.model_api_key }}
          prompt: ${{ steps.prepare_fix_3.outputs.fix_prompt }}
          claude_args: |
            --allowedTools "Edit(src/app/models/${{ inputs.model_id }}/**),Edit(src/app/api/${{ inputs.model_id }}/**),Edit(src/components/icons/Icons.tsx),Edit(public/models/${{ inputs.model_id }}/changelog-jp.json),Edit(public/models/${{ inputs.model_id }}/changelog-en.json),Write(src/app/models/${{ inputs.model_id }}/**),Write(src/app/api/${{ inputs.model_id }}/**),Write(src/components/icons/Icons.tsx),Read,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(gh:*),Glob,Grep,TodoWrite"
          show_full_output: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ inputs.anthropic_model }}
          MODEL_ID: ${{ inputs.model_id }}

      - name: Record Auto-Fix Duration (Attempt 3)
        if: steps.changes.outputs.has_changes == 'true' && env.NEEDS_FIX == 'true'
        run: |
          AUTOFIX_3_END=$(date +%s)
          AUTOFIX_3_DURATION=$((AUTOFIX_3_END - ${autofix_3_start:-0}))
          echo "autofix_3_duration=$AUTOFIX_3_DURATION" >> $GITHUB_ENV

      # === Final Verification ===
      - name: Final Safety Verification
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "Running final verification..."
          npx tsc --noEmit
          npm run build

          # Security pattern checks
          echo "üîí Running security checks..."

          # Check for dangerouslySetInnerHTML (warning only)
          if grep -r "dangerouslySetInnerHTML" src/app/models/${{ inputs.model_id }}/playground src/app/api 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: dangerouslySetInnerHTML detected"
          fi

          # Check for eval/Function in API routes (CRITICAL - blocks push)
          if grep -rE "eval\(|new Function\(|Function\(" src/app/api 2>/dev/null; then
            echo "‚ùå CRITICAL: Code execution patterns detected in API routes!"
            echo "Detected patterns: eval(), new Function(), or Function() constructor"
            exit 1
          fi

          # Check for process.env exposure in client components (warning only)
          if grep -r "process\.env\." src/app/models/${{ inputs.model_id }}/playground --include="*.tsx" --include="*.ts" 2>/dev/null | grep -v "NEXT_PUBLIC_"; then
            echo "‚ö†Ô∏è  Warning: Non-public environment variable may be exposed in client code"
          fi

          # Check for SQL injection patterns (CRITICAL - blocks push)
          if grep -rE "db\.query\(.*\$\{|execute\(.*\$\{|raw\(.*\$\{" src/app/api 2>/dev/null; then
            echo "‚ùå CRITICAL: Potential SQL injection vulnerability!"
            echo "Detected string interpolation in database queries"
            exit 1
          fi

          # Check for unauthorized file system access (CRITICAL - blocks push)
          if grep -rE "fs\.writeFileSync|fs\.unlinkSync|fs\.rmdirSync|child_process\.exec" src/app/api 2>/dev/null; then
            echo "‚ùå CRITICAL: Unauthorized file system/process operations!"
            echo "File system writes and process execution are not allowed"
            exit 1
          fi

          echo "‚úÖ Security checks passed"

      # === Mobile Compatibility Check & Auto-Fix Loop ===
      - name: Mobile Compatibility Check (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true'
        id: mobile_check_1
        continue-on-error: true
        run: |
          echo "üì± Running mobile compatibility checks (Attempt 1)..."

          MOBILE_ERRORS=""

          # Check for hardcoded Canvas sizes
          if grep -rE "const (CANVAS_WIDTH|CANVAS_HEIGHT) = [0-9]+" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null; then
            echo "‚ùå ERROR: Canvas size is hardcoded!"
            MOBILE_ERRORS="$MOBILE_ERRORS\n- Hardcoded CANVAS_WIDTH or CANVAS_HEIGHT found. Must use responsive sizing with window.innerWidth."
            grep -rn "const CANVAS_WIDTH = [0-9]" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null || true
            grep -rn "const CANVAS_HEIGHT = [0-9]" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null || true
          fi

          # Check for window.innerWidth usage (responsive sizing)
          if ! grep -r "window\.innerWidth\|innerWidth" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: No responsive sizing detected"
            MOBILE_ERRORS="$MOBILE_ERRORS\n- No window.innerWidth found. Games should adapt to screen size."
          else
            echo "‚úÖ Responsive sizing detected"
          fi

          # Check for touch event handlers
          if grep -r "touchstart\|touchend\|touchmove" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null; then
            echo "‚úÖ Touch event handlers found"
          else
            echo "‚ö†Ô∏è  WARNING: No touch event handlers detected"
          fi

          if [ -n "$MOBILE_ERRORS" ]; then
            echo "MOBILE_NEEDS_FIX=true" >> $GITHUB_ENV
            echo -e "$MOBILE_ERRORS" > mobile_errors.txt
            echo "‚ùå Mobile compatibility check failed"
            exit 1
          fi

          echo "MOBILE_NEEDS_FIX=false" >> $GITHUB_ENV
          echo "‚úÖ Mobile compatibility check passed"

      - name: Prepare Mobile Fix Prompt (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && steps.mobile_check_1.outcome == 'failure'
        id: prepare_mobile_fix_1
        run: |
          echo "mobile_fix_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "üö® CRITICAL: Mobile compatibility check failed. Fix the following issues:" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          cat mobile_errors.txt >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Required fixes:" >> $GITHUB_OUTPUT
          echo "1. Remove hardcoded CANVAS_WIDTH and CANVAS_HEIGHT constants" >> $GITHUB_OUTPUT
          echo "2. Use useState to manage canvas size dynamically" >> $GITHUB_OUTPUT
          echo "3. Use window.innerWidth and window.innerHeight for responsive sizing" >> $GITHUB_OUTPUT
          echo "4. Add resize event listener to handle screen size changes" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Example implementation:" >> $GITHUB_OUTPUT
          echo "\`\`\`typescript" >> $GITHUB_OUTPUT
          echo "const [canvasSize, setCanvasSize] = useState({ width: 300, height: 400 });" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "useEffect(() => {" >> $GITHUB_OUTPUT
          echo "  const updateSize = () => {" >> $GITHUB_OUTPUT
          echo "    const maxWidth = Math.min(window.innerWidth - 32, 400);" >> $GITHUB_OUTPUT
          echo "    const maxHeight = Math.min(window.innerHeight - 200, 600);" >> $GITHUB_OUTPUT
          echo "    setCanvasSize({ width: maxWidth, height: maxHeight });" >> $GITHUB_OUTPUT
          echo "  };" >> $GITHUB_OUTPUT
          echo "  updateSize();" >> $GITHUB_OUTPUT
          echo "  window.addEventListener('resize', updateSize);" >> $GITHUB_OUTPUT
          echo "  return () => window.removeEventListener('resize', updateSize);" >> $GITHUB_OUTPUT
          echo "}, []);" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Auto-Fix Mobile (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && steps.mobile_check_1.outcome == 'failure'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1.0.29
        with:
          anthropic_api_key: ${{ secrets.model_api_key }}
          prompt: ${{ steps.prepare_mobile_fix_1.outputs.mobile_fix_prompt }}
          claude_args: |
            --allowedTools "Edit(src/app/models/${{ inputs.model_id }}/**),Edit(src/app/api/${{ inputs.model_id }}/**),Edit(src/components/icons/Icons.tsx),Read,Bash(npm:*),Bash(npx:*),Glob,Grep,TodoWrite"
          show_full_output: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ inputs.anthropic_model }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ inputs.anthropic_model }}
          MODEL_ID: ${{ inputs.model_id }}

      - name: Rebuild After Mobile Fix (Attempt 1)
        if: steps.changes.outputs.has_changes == 'true' && steps.mobile_check_1.outcome == 'failure'
        continue-on-error: true
        run: |
          echo "Rebuilding after mobile fix..."
          npm run build

      - name: Mobile Compatibility Check (Attempt 2)
        if: steps.changes.outputs.has_changes == 'true' && steps.mobile_check_1.outcome == 'failure'
        id: mobile_check_2
        continue-on-error: true
        run: |
          echo "üì± Running mobile compatibility checks (Attempt 2)..."

          # Check for hardcoded Canvas sizes
          if grep -rE "const (CANVAS_WIDTH|CANVAS_HEIGHT) = [0-9]+" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null; then
            echo "‚ùå ERROR: Canvas size is still hardcoded!"
            grep -rn "const CANVAS_WIDTH = [0-9]" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null || true
            grep -rn "const CANVAS_HEIGHT = [0-9]" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null || true
            exit 1
          fi

          # Check for window.innerWidth usage
          if ! grep -r "window\.innerWidth\|innerWidth" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Still no responsive sizing detected"
          else
            echo "‚úÖ Responsive sizing detected"
          fi

          echo "‚úÖ Mobile compatibility check passed (Attempt 2)"

      - name: Final Mobile Compatibility Verification
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "üì± Final mobile compatibility verification..."

          # Final check - must pass or fail the workflow
          if grep -rE "const (CANVAS_WIDTH|CANVAS_HEIGHT) = [0-9]+" src/app/models/${{ inputs.model_id }}/playground 2>/dev/null; then
            echo "‚ùå FINAL ERROR: Canvas size is still hardcoded after auto-fix attempts!"
            echo "Manual intervention required."
            exit 1
          fi

          echo "‚úÖ Final mobile compatibility check passed"

      - name: Take After Screenshot
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Dev server is already running from "Start Dev Server" step
          echo "Using existing dev server..."

          # Take screenshot (will be committed to git)
          node scripts/take-screenshot.js
        env:
          MODEL_ID: ${{ inputs.model_id }}
          TZ: Asia/Tokyo

      - name: Upload Before/After Screenshots
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.model_id }}-${{ github.run_id }}
          path: |
            public/models/${{ inputs.model_id }}/screenshots/*-before.png
            public/models/${{ inputs.model_id }}/screenshots/20*.png
          retention-days: 30

      # === Failure Handling (Record Metrics BEFORE Commit) ===
      - name: Record Failure Metrics
        if: failure() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Record metrics even on failure
          WORKFLOW_END=$(date +%s)
          TOTAL_DURATION=$((WORKFLOW_END - ${workflow_start:-0}))
          echo "total_duration=$TOTAL_DURATION" >> $GITHUB_ENV
          echo "final_status=failure" >> $GITHUB_ENV
          node scripts/record-workflow-metrics.js || true
        env:
          MODEL_ID: ${{ inputs.model_id }}
          CLAUDE_CODE_DURATION: ${{ env.claude_code_duration }}
          AUTOFIX_1_DURATION: ${{ env.autofix_1_duration }}
          AUTOFIX_2_DURATION: ${{ env.autofix_2_duration }}
          AUTOFIX_3_DURATION: ${{ env.autofix_3_duration }}
          TOTAL_DURATION: ${{ env.total_duration }}
          BUILD_FAILURES: ${{ env.build_failures }}
          RETRY_COUNT: ${{ env.retry_count }}
          FINAL_STATUS: failure
          TYPESCRIPT_ERRORS: ${{ env.typescript_errors }}
          BUILD_ERRORS: ${{ env.build_errors }}
          SECURITY_ERRORS: ${{ env.security_errors }}
          FILES_CHANGED: ${{ env.files_changed }}
          ADDITIONS: ${{ env.additions }}
          DELETIONS: ${{ env.deletions }}

      - name: Collect Git Statistics (on Failure)
        if: failure() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Statistics for application code only
          GIT_STATS=$(git diff --stat HEAD -- \
            src/app/models/${{ inputs.model_id }}/playground \
            src/app/api/${{ inputs.model_id }} \
            src/components/icons/Icons.tsx | tail -n 1)
          FILES_CHANGED=$(echo "$GIT_STATS" | grep -oP '\d+(?= file)' || echo 0)
          ADDITIONS=$(echo "$GIT_STATS" | grep -oP '\d+(?= insertion)' || echo 0)
          DELETIONS=$(echo "$GIT_STATS" | grep -oP '\d+(?= deletion)' || echo 0)

          echo "files_changed=$FILES_CHANGED" >> $GITHUB_ENV
          echo "additions=$ADDITIONS" >> $GITHUB_ENV
          echo "deletions=$DELETIONS" >> $GITHUB_ENV
          echo "üìä Git Stats (Failure): $FILES_CHANGED files, +$ADDITIONS -$DELETIONS"

      - name: Update Changelog (on Failure)
        if: failure() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Update changelog.json even on failure
          echo "üìù Updating changelog with failure metrics..."
          node scripts/update-changelog.js || true
        env:
          MODEL_ID: ${{ inputs.model_id }}
          AI_MODEL: ${{ inputs.anthropic_model }}
          AI_REASONING: "Workflow failed - partial changes recorded"
          CHANGED_FILES: ""

      - name: Update PR with Failure Status
        if: failure() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Git configuration
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Stage changes (as much as possible)
          git add src/app/models/${{ inputs.model_id }}/playground || true
          git add src/app/api/${{ inputs.model_id }} || true
          git add src/components/icons/Icons.tsx || true
          git add public/models/${{ inputs.model_id }}/changelog-jp.json || true
          git add public/models/${{ inputs.model_id }}/changelog-en.json || true
          git add public/models/${{ inputs.model_id }}/analytics.json || true
          git add public/models/${{ inputs.model_id }}/analytics-previous.json || true
          git add public/models/${{ inputs.model_id }}/screenshots/ || true

          # Security check: exclude changes outside allowed scope
          UNEXPECTED_CHANGES=$(git status --porcelain src/ | grep -vE "src/app/models/${{ inputs.model_id }}/playground(/|$)|src/app/api/${{ inputs.model_id }}(/|$)|src/components/icons/Icons.tsx" || true)

          if [[ -n "$UNEXPECTED_CHANGES" ]]; then
             echo "‚ö†Ô∏è  WARNING: AI modified files outside of allowed scope!"
             echo "$UNEXPECTED_CHANGES"
             echo "$UNEXPECTED_CHANGES" | grep "^[MD]" | awk '{print $2}' | xargs -r git checkout -- 2>/dev/null || true
             echo "$UNEXPECTED_CHANGES" | grep "^A" | awk '{print $2}' | xargs -r git reset HEAD 2>/dev/null || true
             echo "$UNEXPECTED_CHANGES" | grep -E "^(A|\?\?)" | awk '{print $2}' | xargs -r rm -f 2>/dev/null || true
          fi

          # Commit only if there are changes
          if ! git diff --cached --quiet; then
            # Identify failure reason
            FAILURE_REASON="Unknown error"
            if [[ "${{ steps.check_3.outcome }}" == "failure" ]]; then
              FAILURE_REASON="Build/Type check failed after 3 attempts"
            elif [[ "${{ job.status }}" == "failure" ]]; then
              FAILURE_REASON="Security check or final verification failed"
            fi

            git commit -m "üöß AI Evolution (Incomplete) - ${{ inputs.model_display_name }}" \
              -m "Workflow failed - manual review required" \
              -m "Reason: ${FAILURE_REASON}" \
              -m "PR: ${{ steps.create-pr.outputs.pr_url }}" \
              -m "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push origin "${{ steps.create-branch.outputs.branch_name }}" || true

            echo "‚úÖ Partial changes committed to PR branch"
          fi

          # Mark PR with failure status
          gh pr edit ${{ steps.create-pr.outputs.pr_number }} \
            --add-label "failed" \
            --body "## ‚ö†Ô∏è AI Evolution Failed

          **Status:** Failed
          **Reason:** Build or test failures

          Please review workflow logs and fix issues manually.

          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "‚ö†Ô∏è PR #${{ steps.create-pr.outputs.pr_number }} marked as failed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Tokyo
        continue-on-error: true

      # === Success Handling ===
      - name: Collect Git Statistics
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Statistics for application code only
          GIT_STATS=$(git diff --stat HEAD -- \
            src/app/models/${{ inputs.model_id }}/playground \
            src/app/api/${{ inputs.model_id }} \
            src/components/icons/Icons.tsx | tail -n 1)
          FILES_CHANGED=$(echo "$GIT_STATS" | grep -oP '\d+(?= file)' || echo 0)
          ADDITIONS=$(echo "$GIT_STATS" | grep -oP '\d+(?= insertion)' || echo 0)
          DELETIONS=$(echo "$GIT_STATS" | grep -oP '\d+(?= deletion)' || echo 0)

          echo "files_changed=$FILES_CHANGED" >> $GITHUB_ENV
          echo "additions=$ADDITIONS" >> $GITHUB_ENV
          echo "deletions=$DELETIONS" >> $GITHUB_ENV
          echo "üìä Git Stats: $FILES_CHANGED files, +$ADDITIONS -$DELETIONS"

      - name: Record Workflow Metrics
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Calculate total execution time
          WORKFLOW_END=$(date +%s)
          TOTAL_DURATION=$((WORKFLOW_END - ${{ env.workflow_start }}))
          echo "total_duration=$TOTAL_DURATION" >> $GITHUB_ENV

          # Final status
          echo "final_status=success" >> $GITHUB_ENV

          # Record metrics to file
          node scripts/record-workflow-metrics.js
        env:
          MODEL_ID: ${{ inputs.model_id }}
          CLAUDE_CODE_DURATION: ${{ env.claude_code_duration }}
          AUTOFIX_1_DURATION: ${{ env.autofix_1_duration }}
          AUTOFIX_2_DURATION: ${{ env.autofix_2_duration }}
          AUTOFIX_3_DURATION: ${{ env.autofix_3_duration }}
          TOTAL_DURATION: ${{ env.total_duration }}
          BUILD_FAILURES: ${{ env.build_failures }}
          RETRY_COUNT: ${{ env.retry_count }}
          FINAL_STATUS: ${{ env.final_status }}
          TYPESCRIPT_ERRORS: ${{ env.typescript_errors }}
          BUILD_ERRORS: ${{ env.build_errors }}
          SECURITY_ERRORS: ${{ env.security_errors }}
          FILES_CHANGED: ${{ env.files_changed }}
          ADDITIONS: ${{ env.additions }}
          DELETIONS: ${{ env.deletions }}

      - name: Update Changelog with PR Info
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          echo "üìù Adding PR info and metrics to changelog..."
          node scripts/update-changelog-with-pr.js
        env:
          MODEL_ID: ${{ inputs.model_id }}
          PR_URL: ${{ steps.create-pr.outputs.pr_url }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}

      - name: Configure Git
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit to Branch
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Add allowed directories
          git add src/app/models/${{ inputs.model_id }}/playground || true
          git add src/app/api/${{ inputs.model_id }} || true
          git add src/components/icons/Icons.tsx || true

          git add public/models/${{ inputs.model_id }}/changelog-jp.json || echo "No Japanese changelog update"
          git add public/models/${{ inputs.model_id }}/changelog-en.json || echo "No English changelog update"
          git add public/models/${{ inputs.model_id }}/analytics.json || echo "No analytics update"
          git add public/models/${{ inputs.model_id }}/analytics-previous.json || echo "No prev analytics update"
          git add public/models/${{ inputs.model_id }}/screenshots/ || echo "No screenshot update"

          # Safety Check: Fail if files outside allowed scope are modified
          UNEXPECTED_CHANGES=$(git status --porcelain src/ | grep -vE "src/app/models/${{ inputs.model_id }}/playground(/|$)|src/app/api/${{ inputs.model_id }}(/|$)|src/components/icons/Icons.tsx" || true)

          if [[ -n "$UNEXPECTED_CHANGES" ]]; then
             echo "‚ùå CRITICAL ERROR: AI modified files outside of allowed scope!"
             echo "The following files were modified but not allowed:"
             echo "$UNEXPECTED_CHANGES"
             echo "Blocking push to prevent security issues."
             exit 1
          fi

          DATE=$(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M JST')
          git commit -m "${{ inputs.commit_prefix }} (${{ inputs.model_display_name }}) - $DATE" \
            -m "PR: ${{ steps.create-pr.outputs.pr_url }}" \
            -m "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin "${{ steps.create-branch.outputs.branch_name }}"

          echo "‚úÖ Changes committed and pushed to branch: ${{ steps.create-branch.outputs.branch_name }}"
        env:
          TZ: Asia/Tokyo

      - name: Update PR with Final Results
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: node scripts/update-pr-body.js
        env:
          MODEL_ID: ${{ inputs.model_id }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
          BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR (Squash)
        if: success() && steps.changes.outputs.has_changes == 'true'
        run: |
          # Mark PR as ready (remove draft status)
          gh pr ready ${{ steps.create-pr.outputs.pr_number }}

          # Squash merge
          gh pr merge ${{ steps.create-pr.outputs.pr_number }} \
            --squash \
            --delete-branch \
            --subject "${{ inputs.commit_prefix }} (${{ inputs.model_display_name }}) - $(TZ=Asia/Tokyo date +'%Y-%m-%d')" \
            --body "Automated AI evolution completed successfully.

          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "‚úÖ PR #${{ steps.create-pr.outputs.pr_number }} merged successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Tokyo

      - name: Cleanup Dev Server
        if: always()
        run: |
          # Kill dev server if it's still running
          if [ -n "${{ steps.start-dev-server.outputs.dev_pid }}" ]; then
            kill ${{ steps.start-dev-server.outputs.dev_pid }} || true
            echo "‚úÖ Dev server stopped"
          fi
