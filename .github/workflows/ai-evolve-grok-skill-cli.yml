name: AI Evolution (Grok) - CLI Version

on:
  # schedule:
  #   - cron: '30 9 * * *'   # UTC 9:30 (JST 18:30)
  #   - cron: '30 21 * * *'  # UTC 21:30 (JST 6:30)
  workflow_dispatch:
    inputs:
      retry_count:
        description: 'Current retry attempt (0-2)'
        required: false
        default: '0'
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: write  # Required for workflow re-trigger

jobs:
  evolve-grok-cli:
    uses: ./.github/workflows/reusable-evolve-model-skill-cli.yml
    with:
      model_id: 'grok'
      model_display_name: 'Grok (CLI)'
      anthropic_model: 'x-ai/grok-3-mini-beta'
      commit_prefix: 'ü§ñ AI Evolution (CLI)'
    secrets:
      model_api_key: ${{ secrets.GROK_API_KEY }}
      ga4_property_id: ${{ secrets.GA4_PROPERTY_ID }}
      google_application_credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
      serper_api_key: ${{ secrets.SERPER_API_KEY }}

  retry-on-failure:
    needs: evolve-grok-cli
    if: failure() && fromJSON(inputs.retry_count || '0') < 2
    runs-on: ubuntu-latest
    steps:
      - name: Calculate next retry count
        id: calc
        run: |
          CURRENT=${{ inputs.retry_count || '0' }}
          NEXT=$((CURRENT + 1))
          echo "next_count=$NEXT" >> $GITHUB_OUTPUT
          echo "üîÑ Retry attempt $NEXT of 3"

      - name: Wait before retry
        run: |
          echo "‚è≥ Waiting 60 seconds before retry..."
          sleep 60

      - name: Trigger retry
        run: |
          gh workflow run "AI Evolution (Grok) - CLI Version" \
            --repo ${{ github.repository }} \
            -f retry_count=${{ steps.calc.outputs.next_count }}
          echo "‚úÖ Retry triggered (attempt ${{ steps.calc.outputs.next_count }})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  report-final-failure:
    needs: evolve-grok-cli
    if: failure() && fromJSON(inputs.retry_count || '0') >= 2
    runs-on: ubuntu-latest
    steps:
      - name: Report final failure
        run: |
          echo "‚ùå All 3 attempts failed for Grok CLI Evolution"
          echo "Manual intervention required."
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
