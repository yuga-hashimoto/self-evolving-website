name: Debug OpenRouter Connection

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ========================================
      # Test 1: Direct OpenRouter API (curl)
      # ========================================
      - name: "Test 1: Direct OpenRouter API (curl)"
        id: test_curl
        run: |
          echo "ðŸ§ª Testing OpenRouter API directly with curl..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            https://openrouter.ai/api/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.MIMO_API_KEY }}" \
            -d '{
              "model": "xiaomi/mimo-v2-flash:free",
              "messages": [{"role": "user", "content": "Say hello in one word."}],
              "max_tokens": 10
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Test 1 PASSED: Direct API works"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Test 1 FAILED: Direct API failed"
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # Test 2: Claude Code CLI directly
      # ========================================
      - name: Install Claude Code CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | sh
          echo "$HOME/.claude/bin" >> $GITHUB_PATH

      - name: "Test 2: Claude Code CLI directly"
        id: test_cli
        continue-on-error: true
        run: |
          echo "ðŸ§ª Testing Claude Code CLI directly..."

          # Create a simple test
          claude --version || echo "Version check failed"

          # Try a simple prompt
          echo "Say hello" | timeout 60 claude --print \
            --model "xiaomi/mimo-v2-flash:free" \
            --dangerously-skip-permissions \
            2>&1 || true

          echo "result=attempted" >> $GITHUB_OUTPUT
        env:
          ANTHROPIC_API_KEY: ${{ secrets.MIMO_API_KEY }}
          ANTHROPIC_BASE_URL: https://openrouter.ai/api/v1

      # ========================================
      # Test 3: claude-code-action
      # ========================================
      - name: "Test 3: claude-code-action"
        id: test_action
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.MIMO_API_KEY }}
          prompt: "Say hello in one word. Do not use any tools."
          claude_args: |
            --allowedTools ""
          show_full_output: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_MODEL: xiaomi/mimo-v2-flash:free

      # ========================================
      # Summary
      # ========================================
      - name: Summary
        if: always()
        run: |
          echo "======================================"
          echo "           TEST SUMMARY"
          echo "======================================"
          echo ""
          echo "Test 1 (curl):            ${{ steps.test_curl.outputs.result }}"
          echo "Test 2 (CLI):             ${{ steps.test_cli.outputs.result }}"
          echo "Test 3 (claude-code-action): ${{ steps.test_action.outcome }}"
          echo ""
          echo "======================================"
