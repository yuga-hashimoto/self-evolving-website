# API開発ガイドライン

コンバージョンやユーザー体験を向上させるためにAPIルートを作成・修正する際の注意事項：

## 1. セキュリティ最優先
- **入力検証**: Zodなどでリクエストのバリデーションを必ず行う
- **環境変数**: シークレットはprocess.envを使用（APIキーのハードコード禁止）
- **サニタイゼーション**: インジェクション攻撃を防ぐため、ユーザー入力をサニタイズ
- **エラーメッセージ**: デバッグに役立つエラーメッセージを返すが、機密情報は隠す

## 2. エラーハンドリング
- 適切なHTTPステータスコードを返す:
  - 200: 成功
  - 400: 不正なリクエスト（無効な入力）
  - 401: 認証エラー
  - 404: 見つからない
  - 500: サーバー内部エラー
- JSON レスポンスには `NextResponse.json()` を使用
- すべての非同期処理に try-catch ブロックを実装

## 3. パフォーマンス
- 可能な限り Edge Runtime を使用: `export const runtime = 'edge'`
- 適切なヘッダーでキャッシュを実装
- N+1クエリを避ける
- 大きなレスポンスにはストリーミングを使用

## 4. コード例

**良い例: 入力検証**
```typescript
const searchParams = request.nextUrl.searchParams;
const id = searchParams.get('id');
if (!id || !/^[a-zA-Z0-9-]+$/.test(id)) {
  return NextResponse.json({ error: 'Invalid ID' }, { status: 400 });
}
```

**良い例: エラーハンドリング**
```typescript
try {
  const data = await fetchData(id);
  return NextResponse.json(data);
} catch (error) {
  console.error('API Error:', error);
  return NextResponse.json(
    { error: 'Internal server error' },
    { status: 500 }
  );
}
```

**参考**: `src/app/api/analytics/route.ts` を参照してください。適切に構造化された例があります。
